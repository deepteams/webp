// Package lossy implements VP8 lossy codec constants, probability tables,
// and decoder/encoder primitives for WebP lossy compression.
package lossy

// Intra 4x4 prediction modes.
const (
	BDCPred  = 0
	BTMPred  = 1
	BVEPred  = 2
	BHEPred  = 3
	BRDPred  = 4
	BVRPred  = 5
	BLDPred  = 6
	BVLPred  = 7
	BHDPred  = 8
	BHUPred  = 9
	NumBModes = 10
)

// Luma 16x16 and UV prediction modes.
const (
	DCPred       = BDCPred  // 0
	VPred        = BVEPred  // 2
	HPred        = BHEPred  // 3
	TMPred       = BTMPred  // 1
	BPred        = NumBModes // 10 - refined I4x4 mode
	NumPredModes = 4
)

// Special DC prediction modes (for boundary cases).
const (
	BDCPredNoTop     = 4
	BDCPredNoLeft    = 5
	BDCPredNoTopLeft = 6
	NumBDCModes      = 7
)

// Segment and partition constants.
const (
	MBFeatureTreeProbs = 3
	NumMBSegments      = 4
	NumRefLFDeltas     = 4
	NumModeLFDeltas    = 4
	MaxNumPartitions   = 8
)

// Coefficient probability dimensions.
// Type indices: 0=i16-AC, 1=i16-DC, 2=chroma-AC, 3=i4-AC
const (
	NumTypes  = 4
	NumBands  = 8
	NumCTX    = 3
	NumProbas = 11
)

// VP8 bitstream signature (3 bytes: 0x9D 0x01 0x2A).
const VP8Signature = 0x9d012a

// VP8 partition size limits.
const (
	VP8MaxPartition0Size = 1 << 19 // max size of mode partition
	VP8MaxPartitionSize  = 1 << 24 // max size for token partition
	VP8FrameHeaderSize   = 10      // size of the frame header within VP8 data
)

// BPS is the common stride for encoding/decoding buffers (32 bytes = one cacheline).
const BPS = 32

// YUV cache layout sizes.
const (
	YUVSize = BPS*17 + BPS*9
	YOff    = BPS*1 + 8
	UOff    = YOff + BPS*16 + BPS
	VOff    = UOff + 16
)

// KBands maps coefficient index to frequency band (Paragraph 9.9).
// 17 entries: indices 0..15 for the 16 coefficients, plus a sentinel.
var KBands = [16 + 1]uint8{
	0, 1, 2, 3, 6, 4, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7,
	0, // extra entry as sentinel
}

// KZigzag is the scan order for DCT coefficients.
var KZigzag = [16]uint8{
	0, 1, 4, 8, 5, 2, 3, 6,
	9, 12, 13, 10, 7, 11, 14, 15,
}

// KDcTable maps quantizer index [0..127] to DC dequantization factor (Paragraph 14.1).
var KDcTable = [128]uint8{
	4, 5, 6, 7, 8, 9, 10, 10, 11, 12, 13, 14, 15, 16, 17,
	17, 18, 19, 20, 20, 21, 21, 22, 22, 23, 23, 24, 25, 25, 26,
	27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 37, 38, 39, 40,
	41, 42, 43, 44, 45, 46, 46, 47, 48, 49, 50, 51, 52, 53, 54,
	55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69,
	70, 71, 72, 73, 74, 75, 76, 76, 77, 78, 79, 80, 81, 82, 83,
	84, 85, 86, 87, 88, 89, 91, 93, 95, 96, 98, 100, 101, 102, 104,
	106, 108, 110, 112, 114, 116, 118, 122, 124, 126, 128, 130, 132, 134, 136,
	138, 140, 143, 145, 148, 151, 154, 157,
}

// KAcTable maps quantizer index [0..127] to AC dequantization factor.
var KAcTable = [128]uint16{
	4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
	19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33,
	34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48,
	49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 60, 62, 64, 66, 68,
	70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98,
	100, 102, 104, 106, 108, 110, 112, 114, 116, 119, 122, 125, 128, 131, 134,
	137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 177, 181,
	185, 189, 193, 197, 201, 205, 209, 213, 217, 221, 225, 229, 234, 239, 245,
	249, 254, 259, 264, 269, 274, 279, 284,
}

// KAcTable2 maps quantizer index [0..127] to the AC dequantization factor
// for the Y2 (WHT/secondary transform) blocks in the encoder.
// This is a separate table from KAcTable, used by libwebp's encoder
// (quant_enc.c) for more precise Y2 quantization control.
var KAcTable2 = [128]uint16{
	8, 8, 9, 10, 12, 13, 15, 17, 18, 20, 21, 23, 24, 26, 27,
	29, 31, 32, 34, 35, 37, 38, 40, 41, 43, 44, 46, 48, 49, 51,
	52, 54, 55, 57, 58, 60, 62, 63, 65, 66, 68, 69, 71, 72, 74,
	75, 77, 79, 80, 82, 83, 85, 86, 88, 89, 93, 96, 99, 102, 105,
	108, 111, 114, 117, 120, 124, 127, 130, 133, 136, 139, 142, 145, 148, 151,
	155, 158, 161, 164, 167, 170, 173, 176, 179, 184, 189, 193, 198, 203, 207,
	212, 217, 221, 226, 230, 235, 240, 244, 249, 254, 258, 263, 268, 274, 280,
	286, 292, 299, 305, 311, 317, 323, 330, 336, 342, 348, 354, 362, 370, 379,
	385, 393, 401, 409, 416, 424, 432, 440,
}

// KBModesProba contains the intra 4x4 mode probabilities (Paragraph 11.5).
// Indexed as [top_mode][left_mode][prob_index], where prob_index has 9 entries.
var KBModesProba = [NumBModes][NumBModes][NumBModes - 1]uint8{
	{
		{231, 120, 48, 89, 115, 113, 120, 152, 112},
		{152, 179, 64, 126, 170, 118, 46, 70, 95},
		{175, 69, 143, 80, 85, 82, 72, 155, 103},
		{56, 58, 10, 171, 218, 189, 17, 13, 152},
		{114, 26, 17, 163, 44, 195, 21, 10, 173},
		{121, 24, 80, 195, 26, 62, 44, 64, 85},
		{144, 71, 10, 38, 171, 213, 144, 34, 26},
		{170, 46, 55, 19, 136, 160, 33, 206, 71},
		{63, 20, 8, 114, 114, 208, 12, 9, 226},
		{81, 40, 11, 96, 182, 84, 29, 16, 36},
	},
	{
		{134, 183, 89, 137, 98, 101, 106, 165, 148},
		{72, 187, 100, 130, 157, 111, 32, 75, 80},
		{66, 102, 167, 99, 74, 62, 40, 234, 128},
		{41, 53, 9, 178, 241, 141, 26, 8, 107},
		{74, 43, 26, 146, 73, 166, 49, 23, 157},
		{65, 38, 105, 160, 51, 52, 31, 115, 128},
		{104, 79, 12, 27, 217, 255, 87, 17, 7},
		{87, 68, 71, 44, 114, 51, 15, 186, 23},
		{47, 41, 14, 110, 182, 183, 21, 17, 194},
		{66, 45, 25, 102, 197, 189, 23, 18, 22},
	},
	{
		{88, 88, 147, 150, 42, 46, 45, 196, 205},
		{43, 97, 183, 117, 85, 38, 35, 179, 61},
		{39, 53, 200, 87, 26, 21, 43, 232, 171},
		{56, 34, 51, 104, 114, 102, 29, 93, 77},
		{39, 28, 85, 171, 58, 165, 90, 98, 64},
		{34, 22, 116, 206, 23, 34, 43, 166, 73},
		{107, 54, 32, 26, 51, 1, 81, 43, 31},
		{68, 25, 106, 22, 64, 171, 36, 225, 114},
		{34, 19, 21, 102, 132, 188, 16, 76, 124},
		{62, 18, 78, 95, 85, 57, 50, 48, 51},
	},
	{
		{193, 101, 35, 159, 215, 111, 89, 46, 111},
		{60, 148, 31, 172, 219, 228, 21, 18, 111},
		{112, 113, 77, 85, 179, 255, 38, 120, 114},
		{40, 42, 1, 196, 245, 209, 10, 25, 109},
		{88, 43, 29, 140, 166, 213, 37, 43, 154},
		{61, 63, 30, 155, 67, 45, 68, 1, 209},
		{100, 80, 8, 43, 154, 1, 51, 26, 71},
		{142, 78, 78, 16, 255, 128, 34, 197, 171},
		{41, 40, 5, 102, 211, 183, 4, 1, 221},
		{51, 50, 17, 168, 209, 192, 23, 25, 82},
	},
	{
		{138, 31, 36, 171, 27, 166, 38, 44, 229},
		{67, 87, 58, 169, 82, 115, 26, 59, 179},
		{63, 59, 90, 180, 59, 166, 93, 73, 154},
		{40, 40, 21, 116, 143, 209, 34, 39, 175},
		{47, 15, 16, 183, 34, 223, 49, 45, 183},
		{46, 17, 33, 183, 6, 98, 15, 32, 183},
		{57, 46, 22, 24, 128, 1, 54, 17, 37},
		{65, 32, 73, 115, 28, 128, 23, 128, 205},
		{40, 3, 9, 115, 51, 192, 18, 6, 223},
		{87, 37, 9, 115, 59, 77, 64, 21, 47},
	},
	{
		{104, 55, 44, 218, 9, 54, 53, 130, 226},
		{64, 90, 70, 205, 40, 41, 23, 26, 57},
		{54, 57, 112, 184, 5, 41, 38, 166, 213},
		{30, 34, 26, 133, 152, 116, 10, 32, 134},
		{39, 19, 53, 221, 26, 114, 32, 73, 255},
		{31, 9, 65, 234, 2, 15, 1, 118, 73},
		{75, 32, 12, 51, 192, 255, 160, 43, 51},
		{88, 31, 35, 67, 102, 85, 55, 186, 85},
		{56, 21, 23, 111, 59, 205, 45, 37, 192},
		{55, 38, 70, 124, 73, 102, 1, 34, 98},
	},
	{
		{125, 98, 42, 88, 104, 85, 117, 175, 82},
		{95, 84, 53, 89, 128, 100, 113, 101, 45},
		{75, 79, 123, 47, 51, 128, 81, 171, 1},
		{57, 17, 5, 71, 102, 57, 53, 41, 49},
		{38, 33, 13, 121, 57, 73, 26, 1, 85},
		{41, 10, 67, 138, 77, 110, 90, 47, 114},
		{115, 21, 2, 10, 102, 255, 166, 23, 6},
		{101, 29, 16, 10, 85, 128, 101, 196, 26},
		{57, 18, 10, 102, 102, 213, 34, 20, 43},
		{117, 20, 15, 36, 163, 128, 68, 1, 26},
	},
	{
		{102, 61, 71, 37, 34, 53, 31, 243, 192},
		{69, 60, 71, 38, 73, 119, 28, 222, 37},
		{68, 45, 128, 34, 1, 47, 11, 245, 171},
		{62, 17, 19, 70, 146, 85, 55, 62, 70},
		{37, 43, 37, 154, 100, 163, 85, 160, 1},
		{63, 9, 92, 136, 28, 64, 32, 201, 85},
		{75, 15, 9, 9, 64, 255, 184, 119, 16},
		{86, 6, 28, 5, 64, 255, 25, 248, 1},
		{56, 8, 17, 132, 137, 255, 55, 116, 128},
		{58, 15, 20, 82, 135, 57, 26, 121, 40},
	},
	{
		{164, 50, 31, 137, 154, 133, 25, 35, 218},
		{51, 103, 44, 131, 131, 123, 31, 6, 158},
		{86, 40, 64, 135, 148, 224, 45, 183, 128},
		{22, 26, 17, 131, 240, 154, 14, 1, 209},
		{45, 16, 21, 91, 64, 222, 7, 1, 197},
		{56, 21, 39, 155, 60, 138, 23, 102, 213},
		{83, 12, 13, 54, 192, 255, 68, 47, 28},
		{85, 26, 85, 85, 128, 128, 32, 146, 171},
		{18, 11, 7, 63, 144, 171, 4, 4, 246},
		{35, 27, 10, 146, 174, 171, 12, 26, 128},
	},
	{
		{190, 80, 35, 99, 180, 80, 126, 54, 45},
		{85, 126, 47, 87, 176, 51, 41, 20, 32},
		{101, 75, 128, 139, 118, 146, 116, 128, 85},
		{56, 41, 15, 176, 236, 85, 37, 9, 62},
		{71, 30, 17, 119, 118, 255, 17, 18, 138},
		{101, 38, 60, 138, 55, 70, 43, 26, 142},
		{146, 36, 19, 30, 171, 255, 97, 27, 20},
		{138, 45, 61, 62, 219, 1, 81, 188, 64},
		{32, 41, 20, 117, 151, 142, 20, 21, 163},
		{112, 19, 12, 61, 195, 128, 48, 4, 24},
	},
}

// KYModesIntra4 is a tree-coding table for intra 4x4 mode parsing.
var KYModesIntra4 = [18]int8{
	-BDCPred, 1, -BTMPred, 2, -BVEPred, 3,
	4, 6, -BHEPred, 5, -BRDPred, -BVRPred,
	-BLDPred, 7, -BVLPred, 8, -BHDPred, -BHUPred,
}

// Coefficient category extra-bit tables for decoding large values (Section 13.2).
var (
	KCat3 = [...]uint8{173, 148, 140, 0}
	KCat4 = [...]uint8{176, 155, 140, 135, 0}
	KCat5 = [...]uint8{180, 157, 141, 134, 130, 0}
	KCat6 = [...]uint8{254, 254, 243, 230, 196, 177, 153, 140, 133, 130, 129, 0}
)
